
# توثيق وظيفة دعوة المستخدمين (invite_user)

تعمل هذه الوظيفة كـ Edge Function بصلاحيات `Service Role` لتجاوز قيود التسجيل المفتوح.

### مسار التحقق (Security Flow)
1. **المصادقة:** التحقق من وجود توكن صالح للمستخدم الداعي عبر `auth.getUser()`.
2. **الصلاحية:** الاستعلام عن دور الداعي في جدول `user_roles`. يجب أن يكون `OWNER` في نفس `company_id` المطلوبة.
3. **التنفيذ:**
   - استخدام `auth.admin.inviteUserByEmail` لإرسال البريد الرسمي.
   - إنشاء سجل في `public.profiles` بالاسم المرسل.
   - إسناد الدور (Role) المطلوب في `public.user_roles`.

### حالات الخطأ المتوقعة
| الحالة | الرسالة | السبب |
| :--- | :--- | :--- |
| 401 | Unauthorized | التوكن مفقود أو غير صالح. |
| 403 | Only owners can invite | مستخدم يحاول الدعوة وهو ليس OWNER. |
| 400 | Email already exists | البريد مسجل مسبقاً في نظام Supabase Auth. |

### معايير الأمان
- لا يمكن تمرير `company_id` عشوائية؛ يتم التحقق من امتلاك الداعي للشركة.
- كلمة المرور تُضبط من قبل المستخدم المدعو عند قبول الدعوة.
